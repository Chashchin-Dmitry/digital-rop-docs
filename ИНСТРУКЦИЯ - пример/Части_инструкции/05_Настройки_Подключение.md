# 5. Настройки - Подключение

Технический раздел для настройки интеграции с внешней CRM системой через API.

## Общий вид

**Подключение. Технические параметры для отправки аудио в систему.png** - Настройки API интеграции

{TECHNICAL} Страница содержит параметры для интеграции с CRM: URL для отправки файлов, API-ключ и настройки минимального времени звонка. Доступ только администраторам системы.

### Основные настройки:

#### URL для отправки файлов:
```
http://10.28.32.81/api/v1/calls/audio-upload?apiKey=YOUR_API_KEY
```

#### API-ключ:
```
LS6gz1bkpG3lZI6uXetEoLtoVtVXYuWO
```

#### Минимальное время звонка:
- Поле для установки минимальной длительности звонка (в примере: 0)
- Звонки короче указанного времени не будут обрабатываться

## Параметры API запроса

### Обязательные поля:
- **"call_id"**: Уникальный ID звонка в CRM Заказчика
- **"audio_url"**: Прямая ссылка на аудиофайл (система скачает файл по этой ссылке)
- **"duration"**: Длительность в секундах (максимум 2700 сек = 45 мин)
- **"manager_id"**: ID менеджера в CRM Заказчика  
- **"deal_id"**: ID сделки для группировки

### Необязательные поля:
- **"deal_stage_id"**: ID стадии сделки
- **"stage_id"**: ID воронки продаж
- **"stage"**: Название воронки продаж

## Техническая спецификация

### Endpoint для загрузки аудио по ссылкам:
**URL**: `POST http://10.28.32.81/api/v1/calls/audio-upload?apiKey=LS6gz1bkpG3lZI6uXetEoLtoVtVXYuWO`

**Принцип работы**: CRM отправляет ссылки на аудиофайлы, система "Цифровой РОП" скачивает и обрабатывает файлы по этим ссылкам.

**Пример cURL запроса**:
```bash
curl --location --request POST 'http://10.28.32.81/api/v1/calls/audio-upload?apiKey=LS6gz1bkpG3lZI6uXetEoLtoVtVXYuWO' \
--form 'manager_id="mgr_001"' \
--form 'call_id="call_12345_20250619"' \
--form 'deal_id="deal_5678"' \
--form 'deal_stage_id="stage_qualification"' \
--form 'audio_url="https://crm.company.com/files/audio/call_12345.mp3"'
```

### Альтернативный JSON API:
**URL**: `POST http://10.28.32.81/api/v1/calls?apiKey=LS6gz1bkpG3lZI6uXetEoLtoVtVXYuWO`

**Структура JSON запроса**:
```json
{
  "call_id": "call_12345_20250619",
  "audio_url": "https://crm.company.com/files/audio/call_12345.mp3",
  "duration": 900,
  "manager_id": "mgr_001",
  "manager_name": "Иванов Иван Петрович",
  "deal_id": "deal_5678",
  "deal_stage_id": "stage_qualification",
  "stage_id": "funnel_primary_calls"
}
```

## Технические требования к аудиофайлам

### Поддерживаемые форматы:
- MP3, WAV, OGG
- Качество: минимум 8 кГц, рекомендуется 16 кГц
- Максимальная длительность: 45 минут

### Доступность файлов по ссылкам:
- Аудиофайлы должны быть доступны по прямой ссылке для скачивания
- Авторизация не требуется во внутреннем контуре компании
- При превышении 45 минут система автоматически разделит файл на части
- Система скачивает файл по переданной ссылке и затем обрабатывает

## Ответы сервера

### Успешная обработка (200 OK):
```json
{
  "status": "success",
  "message": "Звонок успешно получен и поставлен в очередь на анализ",
  "task_id": "task_abc123def456",
  "estimated_processing_time": "5-15 минут"
}
```

### Типичные ошибки:
- **400 Bad Request**: "Файл не является аудио и мы не смогли определить его длину"
- **401 Unauthorized**: Недействительный API ключ
- **409 Conflict**: Звонок с данным call_id уже обработан
- **Download Error**: "файл скачать не может" - проблемы доступа к ссылке

## Безопасность и администрирование

### Доступ к настройкам:
- Раздел доступен только администраторам
- Менеджеры и другие роли не видят API настройки
- API ключ генерируется один раз и не может быть изменен

### Важные примечания:
- Сохраните API ключ в надежном месте
- URL для webhook-ов нельзя изменить после настройки
- Готовая ссылка предоставляется для удобства интеграции

## Исходящие Webhook-и

### Типы уведомлений:
1. **Результаты чек-листа** - оценка соблюдения скрипта
2. **Результаты аналитики** - данные пользовательских таблиц

### Время отправки:
- Результаты отправляются через 5-15 минут после обработки аудио
- Webhook-и отправляются на endpoints, настроенные в CRM Заказчика

## Процесс интеграции

1. **CRM отправляет данные**: Передача ссылки на аудиофайл и метаданных звонка
2. **Система скачивает аудио**: "Цифровой РОП" загружает файл по переданной ссылке
3. **Обработка и анализ**: ИИ анализирует аудиофайл по настроенным критериям
4. **Отправка результатов**: Готовые результаты передаются обратно в CRM через webhook-и

## Ключевые особенности:

1. **Передача по ссылкам** - CRM отправляет URL, система скачивает файлы
2. **Двунаправленная интеграция** - входящий API и исходящие webhook-и
3. **Гибкость форматов** - поддержка form-data и JSON
4. **Автоматическая обработка** - постановка в очередь и фоновый анализ
5. **Контроль дублирования** - защита от повторной обработки звонков
6. **Техническая надежность** - детальные коды ответов и обработка ошибок

## См. также

- [API документация](#api-документация) - полное техническое описание всех методов
- [Настройки - Скрипты и промты](#настройки-скрипты-и-промты) - настройка webhooks для чек-листов
- [Настройки - Таблицы](#настройки-таблицы) - настройка webhooks для аналитических таблиц
- [Администрирование системы](#администрирование-системы) - управление техническими настройками