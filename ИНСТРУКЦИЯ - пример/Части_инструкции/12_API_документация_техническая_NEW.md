# Техническая документация API

Раздел для разработчиков и системных интеграторов по работе с REST API системы "Цифровой РОП".

## Общие принципы работы

### Базовый URL и аутентификация

{TECHNICAL} Все запросы к API должны содержать параметр apiKey с ключом доступа. API ключ можно получить в разделе [Настройки - Подключение](#настройки-подключение) системы. Базовый URL системы: http://10.28.32.81/api/v1

### Коды ответов API

{TECHNICAL} Стандартные HTTP коды ответов системы:

| Код | Описание | Применение |
|-----|----------|------------|
| 200 | OK | Успешная обработка запроса |
| 400 | Bad Request | Некорректные параметры запроса |
| 401 | Unauthorized | Неверный или отсутствующий API ключ |
| 404 | Not Found | Запрашиваемый ресурс не найден |
| 409 | Conflict | Дублирование данных |
| 500 | Internal Server Error | Внутренняя ошибка сервера |

### HTTP методы

{INTERFACE} Система поддерживает стандартные HTTP методы:
- POST для отправки данных в систему
- GET для получения информации  
- Webhook для автоматической отправки результатов в CRM

## Входящие методы API

### Загрузка аудиозаписей звонков

{INTERFACE} Метод для отправки ссылки на аудиофайл для анализа системой.

Endpoint: POST http://10.28.32.81/api/v1/calls/audio-upload?apiKey={API_KEY}

Параметры запроса:
- manager_id - ID менеджера из CRM (обязательный)
- call_id - Уникальный ID звонка (обязательный)
- deal_id - ID сделки в CRM (обязательный)
- deal_stage_id - ID этапа сделки (обязательный)
- audio_url - URL для скачивания аудио (обязательный)
- duration - Длительность в секундах (опциональный)

{TECHNICAL} Пример запроса через cURL:
curl --location --request POST 'http://10.28.32.81/api/v1/calls/audio-upload?apiKey=YOUR_API_KEY' \
--form 'manager_id="mgr_001"' \
--form 'call_id="call_12345_20250619"' \
--form 'deal_id="deal_5678"' \
--form 'deal_stage_id="stage_qualification"' \
--form 'audio_url="https://crm.company.com/files/audio/call_12345.mp3"'

Коды ответов:
- 200 OK - Звонок успешно получен и поставлен в очередь на анализ
- 400 Bad Request - Файл не является аудио
- 401 Unauthorized - Неверный apiKey
- 409 Conflict - Звонок с данным call_id уже обработан

### Обновление структуры офисов

{INTERFACE} Метод для синхронизации структуры офисов и сотрудников.

Endpoint: POST http://10.28.32.81/api/v1/settings/offices-update?apiKey={API_KEY}

Структура запроса:
- offices - массив офисов (обязательный)
  - office_title - название офиса (строка)
  - office_id - ID офиса (строка)
  - leader_ids - массив UUID руководителей
  - managers_ids - массив UUID менеджеров

{TECHNICAL} Пример запроса:
{
  "offices": [
    {
      "office_title": "Офис продаж Центр",
      "office_id": "office_001",
      "leader_ids": ["leader_123", "leader_456"],
      "managers_ids": ["manager_789", "manager_012"]
    }
  ]
}

### Обновление данных менеджеров

{INTERFACE} Метод для синхронизации информации о менеджерах.

Endpoint: POST http://10.28.32.81/api/v1/settings/managers-update?apiKey={API_KEY}

Структура запроса:
- managers - массив менеджеров (обязательный)
  - manager_id - ID менеджера (строка)
  - name - имя (строка)
  - surname - фамилия (строка)
  - middlename - отчество (строка)

{TECHNICAL} Пример запроса:
{
  "managers": [
    {
      "manager_id": "manager_789",
      "name": "Иван",
      "surname": "Иванов",
      "middlename": "Иванович"
    }
  ]
}

### Проверка готовности результатов таблицы

{INTERFACE} Метод для проверки готовности результатов аналитической таблицы.

Endpoint: GET http://10.28.32.81/api/v1/tables/call-ready?tab={TABLE_ID}&call={CALL_ID}

Параметры:
- tab - идентификатор таблицы (например: TBL_1755863365)
- call - идентификатор звонка

{TECHNICAL} Пример ответа при готовности:
{
  "ready": true,
  "data": {
    "field1": "значение1",
    "field2": "значение2",
    "custom_field": "результат анализа"
  }
}

## Исходящие webhook-уведомления

### Результаты проверки по чек-листу

{INTERFACE} Автоматическая отправка результатов анализа звонка по корпоративному скрипту.

Настройка: URL webhook настраивается в разделе [Настройки - Скрипты и промты](#настройки-скрипты-и-промты) для каждого чек-листа отдельно.

{TECHNICAL} Формат данных результатов чек-листа:

| Поле | Тип | Описание |
|------|-----|----------|
| call_id | string | Идентификатор звонка |
| manager_id | string | ID менеджера |
| checklist_name | string | Название чек-листа |
| total_score | integer | Общий балл |
| max_score | integer | Максимальный балл |
| completion_percentage | float | Процент выполнения |
| stages | array | Массив этапов с детализацией |
| stage_id | string | ID этапа |
| stage_name | string | Название этапа |
| score | integer | Балл за этап (1 или -1) |
| percentage | float | Процент выполнения |
| status | string | Статус (completed/failed) |
| comment | string | Комментарий анализа |
| quote | string | Цитата из разговора |
| timestamp | datetime | Время анализа |

### Результаты аналитических таблиц

{INTERFACE} Отправка результатов кастомного анализа по настроенным таблицам.

Настройка: URL webhook настраивается индивидуально для каждой таблицы в разделе [Настройки - Таблицы](#настройки-таблицы).

{TECHNICAL} Формат данных:
- call_id - идентификатор звонка
- table_id - ID таблицы
- table_name - название таблицы
- extracted_data - объект с результатами анализа (поля зависят от настроенной структуры таблицы)
- processing_time - время обработки
- timestamp - время завершения

## Коды ответов и обработка ошибок

### Рекомендации по обработке ошибок

{INTERFACE} При интеграции следует реализовать:
- Логирование всех запросов и ответов для отладки
- Повторные попытки при ошибках 5xx с экспоненциальной задержкой
- Проверку целостности данных перед отправкой
- Обработку таймаутов и сетевых ошибок

## Ограничения и безопасность

### Технические ограничения

{TECHNICAL} Система имеет следующие ограничения:
- Максимальный размер аудиофайла: 100 МБ
- Поддерживаемые форматы: MP3, WAV, OGG
- Максимальная длительность: 45 минут (2700 секунд)
- Частота запросов: не более 60 запросов в минуту

### Требования безопасности

{INTERFACE} Для обеспечения безопасности интеграции:
- Храните API ключ в безопасном месте, не передавайте в открытом виде
- Используйте HTTPS для передачи данных в продакшене
- Проверяйте SSL-сертификаты при установке соединений
- Реализуйте ротацию API ключей по мере необходимости

## Тестирование API

### Проверка доступности

{TECHNICAL} Для тестирования интеграции используйте базовые команды:

Тест доступности API:
curl -X GET "http://10.28.32.81/api/v1/tables/call-ready?tab=test&call=1"

Тест загрузки звонка:
curl --location --request POST 'http://10.28.32.81/api/v1/calls/audio-upload?apiKey=YOUR_API_KEY' \
--form 'manager_id="test_manager"' \
--form 'call_id="test_call_001"' \
--form 'audio_url="https://example.com/test.mp3"'

## Процесс интеграции

### Этап подготовки

{INTERFACE} Перед началом интеграции:
1. Получите API ключ у администратора системы
2. Убедитесь в доступности URL http://10.28.32.81 из вашей сети
3. Подготовьте тестовые аудиофайлы для проверки
4. Настройте среду разработки и тестирования

### Этап реализации

{INTERFACE} Последовательность действий:
1. Реализуйте отправку POST запросов на endpoint загрузки звонков
2. Обработайте возможные ошибки и коды ответов
3. Протестируйте на тестовых данных с различными сценариями
4. Создайте endpoint в вашей CRM для получения webhook
5. Настройте URL webhook в интерфейсе "Цифровой РОП"

### Этап синхронизации данных

{INTERFACE} Настройка обмена данными:
1. Настройте отправку структуры офисов через соответствующий endpoint
2. Реализуйте синхронизацию менеджеров
3. Протестируйте корректность отображения в системе
4. Настройте регулярную синхронизацию при изменениях

### Продакшн и мониторинг

{INTERFACE} Переход в боевой режим:
1. Переведите интеграцию в продакшн
2. Настройте мониторинг и логирование работы API
3. Реализуйте систему оповещений об ошибках
4. Создайте процедуры для обработки сбоев и восстановления

## Техническая поддержка

### Отладка интеграции

{TECHNICAL} При возникновении проблем проверьте:
- Корректность API ключа в каждом запросе
- Доступность URL системы из вашей сети
- Формат передаваемых данных (JSON, form-data)
- Кодировку и структуру аудиофайлов
- Логи запросов и ответов на стороне CRM


## См. также

- [Настройки - Подключение](#настройки-подключение) - конфигурация интеграций в интерфейсе
- [Настройки - Скрипты и промты](#настройки-скрипты-и-промты) - настройка webhook для чек-листов
- [Настройки - Таблицы](#настройки-таблицы) - настройка webhook для аналитических таблиц
- [Полный цикл обработки звонка](#полный-цикл-обработки-звонка) - описание процесса анализа